{"entries":[{"timestamp":1756007732950,"editorVersion":"2.0.56","changes":[{"type":"edited","filename":"main.ts","patch":[{"start1":0,"length1":0,"diffs":[[1," "]]}]},{"type":"edited","filename":"pxt.json","patch":[{"start1":153,"length1":43,"diffs":[[1,"        \"assets.json\"\n"]]},{"start1":182,"length1":44,"diffs":[[1,""]]},{"start1":214,"length1":45,"diffs":[[1,"    \"languageRestriction\": \"javascript-only\",\n    \"additionalFilePaths\": []\n"]]}]},{"type":"added","filename":"test.ts","value":"// tests go here; this will not be compiled when this package is used as an extension.\n"},{"type":"added","filename":"main.blocks","value":"<xml xmlns=\"http://www.w3.org/1999/xhtml\">\n  <variables></variables>\n  <block type=\"pxt-on-start\" x=\"0\" y=\"0\"></block>\n</xml>"},{"type":"added","filename":"prompt.ts","value":"namespace prompt {\n    export interface PromptTheme {\n        colorPrompt: number;\n        colorInput: number;\n        colorInputHighlighted: number;\n        colorInputText: number;\n        colorAlphabet: number;\n        colorCursor: number;\n        colorBackground: number;\n        colorBottomBackground: number;\n        colorBottomText: number;\n    }\n\n    /**\n     * Ask the player for a string value.\n     * @param message The message to display on the text-entry screen\n     * @param answerLength The maximum number of characters the user can enter (1 - 24)\n     */\n    //% group=\"Gameplay\"\n    //% weight=10 help=game/ask-for-string\n    //% blockId=gameaskforstring block=\"ask for string %message || and max length %answerLength\"\n    //% message.defl=\"\"\n    //% answerLength.defl=\"12\"\n    //% answerLength.min=1\n    //% answerLength.max=24\n    //% group=\"Prompt\"\n    export function askForString(message: string, answerLength = 12) {\n        let p = new Prompt();\n        const result = p.show(message, answerLength);\n        return result;\n    }\n\n\n    //% whenUsed=true\n    const font = image.font8; // FONT8-TODO\n    //% whenUsed=true\n    const PADDING = 4;\n    //% whenUsed=true\n    const PROMPT_LINE_SPACING = 2;\n\n    //% whenUsed=true\n    const NUM_LETTERS = 26;\n    //% whenUsed=true\n    const ALPHABET_ROW_LENGTH = 12;\n    //% whenUsed=true\n    const NUM_ROWS = Math.ceil(NUM_LETTERS / ALPHABET_ROW_LENGTH);\n    //% whenUsed=true\n    const INPUT_ROWS = 2;\n\n    //% whenUsed=true\n    const CONTENT_WIDTH = screen.width - PADDING * 2;\n    //% whenUsed=true\n    const CONTENT_HEIGHT = screen.height - PADDING * 2;\n    //% whenUsed=true\n    const CONTENT_TOP = PADDING;\n\n    // Dimensions of a \"cell\" that contains a letter\n    //% whenUsed=true\n    const CELL_WIDTH = Math.floor(CONTENT_WIDTH / ALPHABET_ROW_LENGTH);\n    //% whenUsed=true\n    const CELL_HEIGHT = CELL_WIDTH;\n    //% whenUsed=true\n    const LETTER_OFFSET_X = Math.floor((CELL_WIDTH - font.charWidth) / 2);\n    //% whenUsed=true\n    const LETTER_OFFSET_Y = Math.floor((CELL_HEIGHT - font.charHeight) / 2);\n    //% whenUsed=true\n    const BLANK_PADDING = 1;\n    //% whenUsed=true\n    const ROW_LEFT = PADDING + CELL_WIDTH / 2 + Math.floor((CONTENT_WIDTH - (CELL_WIDTH * ALPHABET_ROW_LENGTH)) / 2);\n\n    // Dimensions of the bottom bar\n    //% whenUsed=true\n    const BOTTOM_BAR_ALPHABET_MARGIN = 4;\n    //% whenUsed=true\n    const BOTTOM_BAR_HEIGHT = PADDING + BOTTOM_BAR_ALPHABET_MARGIN + CELL_HEIGHT;\n    //% whenUsed=true\n    const BOTTOM_BAR_TOP = screen.height - BOTTOM_BAR_HEIGHT;\n    //% whenUsed=true\n    const BOTTOM_BAR_BUTTON_WIDTH = PADDING * 2 + font.charWidth * 3;\n    //% whenUsed=true\n    const BOTTOM_BAR_TEXT_Y = (BOTTOM_BAR_HEIGHT - font.charHeight) / 2;\n    //% whenUsed=true\n    const BOTTOM_BAR_SHIFT_X = (BOTTOM_BAR_BUTTON_WIDTH - font.charWidth * 3) / 2;\n    //% whenUsed=true\n    const BOTTOM_BAR_CONFIRM_X = (BOTTOM_BAR_BUTTON_WIDTH - font.charWidth * 2) / 2;\n    //% whenUsed=true\n    const CONFIRM_BUTTON_LEFT = screen.width - BOTTOM_BAR_BUTTON_WIDTH;\n\n    // Dimensions of the alphabet area\n    //% whenUsed=true\n    const ALPHABET_HEIGHT = NUM_ROWS * CELL_HEIGHT;\n    //% whenUsed=true\n    const ALPHABET_TOP = CONTENT_TOP + CONTENT_HEIGHT - ALPHABET_HEIGHT - BOTTOM_BAR_HEIGHT;\n    //% whenUsed=true\n    const ALPHABET_INPUT_MARGIN = 10;\n\n    // Dimensions of area where text is input\n    //% whenUsed=true\n    const INPUT_HEIGHT = INPUT_ROWS * CELL_HEIGHT;\n    //% whenUsed=true\n    const INPUT_TOP = ALPHABET_TOP - INPUT_HEIGHT - ALPHABET_INPUT_MARGIN;\n\n    // Dimensions of prompt message area\n    //% whenUsed=true\n    const PROMPT_HEIGHT = INPUT_TOP - CONTENT_TOP;\n\n    //% whenUsed=true\n    const lowerShiftText = \"ABC\";\n    //% whenUsed=true\n    const upperShiftText = \"abc\";\n    //% whenUsed=true\n    const digitsUpper = [\" \", \",\", \".\", \"?\", \"!\", \":\", \";\", \"\\\"\", \"(\", \")\"];\n    //% whenUsed=true\n    const confirmText = \"OK\";\n\n\n    export class Prompt {\n        theme: PromptTheme;\n\n        message: string;\n        answerLength: number;\n        result: string;\n\n        private cursor: Sprite;\n        private shiftButton: Sprite;\n        private confirmButton: Sprite;\n\n        private letters: Sprite[];\n        private inputs: Sprite[];\n\n        private confirmPressed: boolean;\n        private cursorRow: number;\n        private cursorColumn: number;\n        private upper: boolean;\n        private inputIndex: number;\n        private blink: boolean;\n        private frameCount: number;\n\n        constructor(theme?: PromptTheme) {\n            if (theme) {\n                this.theme = theme;\n            }\n            else {\n                this.theme = {\n                    colorPrompt: 1,\n                    colorInput: 3,\n                    colorInputHighlighted: 5,\n                    colorInputText: 1,\n                    colorAlphabet: 1,\n                    colorCursor: 7,\n                    colorBackground: 15,\n                    colorBottomBackground: 3,\n                    colorBottomText: 1,\n                };\n            }\n            this.cursorRow = 0;\n            this.cursorColumn = 0;\n            this.upper = false;\n            this.inputIndex = 0;\n        }\n\n        show(message: string, answerLength: number) {\n            this.message = message;\n            this.answerLength = answerLength;\n            this.inputIndex = 0;\n\n            controller._setUserEventsEnabled(false);\n            game.pushScene()\n\n            this.draw();\n            this.registerHandlers();\n            this.confirmPressed = false;\n\n            pauseUntil(() => this.confirmPressed);\n\n            game.popScene();\n            controller._setUserEventsEnabled(true);\n\n            return this.result;\n        }\n\n        private draw() {\n            this.drawPromptText();\n            this.drawKeyboard();\n            this.drawInputarea();\n            this.drawBottomBar();\n        }\n\n        private drawPromptText() {\n            const prompt = sprites.create(layoutText(this.message, CONTENT_WIDTH, PROMPT_HEIGHT, this.theme.colorPrompt), -1);\n            prompt.x = screen.width / 2\n            prompt.y = CONTENT_TOP + Math.floor((PROMPT_HEIGHT - prompt.height) / 2) + Math.floor(prompt.height / 2);\n        }\n\n        private drawInputarea() {\n            const answerLeft = ROW_LEFT + Math.floor(\n                ((CELL_WIDTH * ALPHABET_ROW_LENGTH) -\n                    CELL_WIDTH * Math.min(this.answerLength, ALPHABET_ROW_LENGTH)) / 2);\n\n            this.inputs = [];\n            for (let i = 0; i < this.answerLength; i++) {\n                const blank = image.create(CELL_WIDTH, CELL_HEIGHT);\n                this.drawInput(blank, \"\", this.theme.colorInput);\n\n                const col = i % ALPHABET_ROW_LENGTH;\n                const row = Math.floor(i / ALPHABET_ROW_LENGTH);\n\n                const s = sprites.create(blank, -1);\n                s.x = answerLeft + col * CELL_WIDTH;\n                s.y = INPUT_TOP + row * CELL_HEIGHT;\n                this.inputs.push(s);\n            }\n        }\n\n        private drawKeyboard() {\n            const cursorImage = image.create(CELL_WIDTH, CELL_HEIGHT);\n            cursorImage.fill(this.theme.colorCursor);\n            this.cursor = sprites.create(cursorImage, -1);\n            this.cursor.z = -1;\n            this.updateCursor();\n\n            this.letters = [];\n            for (let j = 0; j < 36; j++) {\n                const letter = image.create(CELL_WIDTH, CELL_HEIGHT);\n\n                const col2 = j % ALPHABET_ROW_LENGTH;\n                const row2 = Math.floor(j / ALPHABET_ROW_LENGTH);\n\n                const t = sprites.create(letter, -1);\n                t.x = ROW_LEFT + col2 * CELL_WIDTH;\n                t.y = ALPHABET_TOP + row2 * CELL_HEIGHT;\n\n                this.letters.push(t);\n            }\n            this.updateKeyboard();\n        }\n\n        private drawBottomBar() {\n            const bg = image.create(screen.width, BOTTOM_BAR_HEIGHT);\n            bg.fill(this.theme.colorBottomBackground);\n\n            const bgSprite = sprites.create(bg, -1);\n            bgSprite.x = screen.width / 2;\n            bgSprite.y = BOTTOM_BAR_TOP + BOTTOM_BAR_HEIGHT / 2;\n            bgSprite.z = -1;\n\n            this.shiftButton = sprites.create(image.create(BOTTOM_BAR_BUTTON_WIDTH, BOTTOM_BAR_HEIGHT), -1);\n            this.shiftButton.x = Math.floor(BOTTOM_BAR_BUTTON_WIDTH / 2);\n            this.shiftButton.y = BOTTOM_BAR_TOP + Math.ceil(BOTTOM_BAR_HEIGHT / 2);\n\n            this.confirmButton = sprites.create(image.create(BOTTOM_BAR_BUTTON_WIDTH, BOTTOM_BAR_HEIGHT), -1);\n            this.confirmButton.x = CONFIRM_BUTTON_LEFT + Math.floor(BOTTOM_BAR_BUTTON_WIDTH / 2);\n            this.confirmButton.y = BOTTOM_BAR_TOP + Math.ceil(BOTTOM_BAR_HEIGHT / 2);\n\n            this.updateButtons();\n        }\n\n        private updateButtons() {\n            if (this.cursorRow === 3 && this.cursorColumn % 2 !== 1) {\n                this.shiftButton.image.fill(this.theme.colorCursor);\n            }\n            else {\n                this.shiftButton.image.fill(this.theme.colorBottomBackground);\n            }\n\n            if (this.upper) {\n                this.shiftButton.image.print(upperShiftText, BOTTOM_BAR_SHIFT_X, BOTTOM_BAR_TEXT_Y);\n            }\n            else {\n                this.shiftButton.image.print(lowerShiftText, BOTTOM_BAR_SHIFT_X, BOTTOM_BAR_TEXT_Y);\n            }\n\n\n            if (this.cursorRow === 3 && this.cursorColumn % 2) {\n                this.confirmButton.image.fill(this.theme.colorCursor);\n            }\n            else {\n                this.confirmButton.image.fill(this.theme.colorBottomBackground);\n            }\n\n            this.confirmButton.image.print(confirmText, BOTTOM_BAR_CONFIRM_X, BOTTOM_BAR_TEXT_Y);\n        }\n\n        private updateCursor() {\n            if (this.cursorRow === 3) {\n                this.cursor.image.fill(0);\n                this.updateButtons();\n            }\n            else {\n                this.cursor.x = ROW_LEFT + this.cursorColumn * CELL_WIDTH;\n                this.cursor.y = ALPHABET_TOP + this.cursorRow * CELL_HEIGHT;\n            }\n        }\n\n        private updateSelectedInput() {\n            if (this.inputIndex < this.answerLength) {\n                const u = this.inputs[this.inputIndex];\n                if (this.blink) {\n                    this.drawInput(u.image, \"\", this.theme.colorInput);\n                }\n                else {\n                    this.drawInput(u.image, \"\", this.theme.colorInputHighlighted)\n                }\n            }\n        }\n\n        private updateKeyboard() {\n            const len = this.letters.length;\n            for (let k = 0; k < len; k++) {\n                const img = this.letters[k].image;\n                img.fill(0);\n                img.print(getCharForIndex(k, this.upper), LETTER_OFFSET_X, LETTER_OFFSET_Y);\n            }\n        }\n\n        private drawInput(img: Image, char: string, color: number) {\n            img.fill(0);\n            img.fillRect(BLANK_PADDING, CELL_HEIGHT - 1, CELL_WIDTH - BLANK_PADDING * 2, 1, color)\n\n            if (char) {\n                img.print(char, LETTER_OFFSET_X, LETTER_OFFSET_Y, this.theme.colorInputText, font);\n            }\n        }\n\n        private registerHandlers() {\n            controller.up.onEvent(SYSTEM_KEY_DOWN, () => {\n                this.moveVertical(true);\n            })\n\n            controller.down.onEvent(SYSTEM_KEY_DOWN, () => {\n                this.moveVertical(false);\n            })\n\n            controller.right.onEvent(SYSTEM_KEY_DOWN, () => {\n                this.moveHorizontal(true);\n            });\n\n            controller.left.onEvent(SYSTEM_KEY_DOWN, () => {\n                this.moveHorizontal(false);\n            });\n\n            controller.A.onEvent(SYSTEM_KEY_DOWN, () => {\n                this.confirm();\n            });\n\n            controller.B.onEvent(SYSTEM_KEY_DOWN, () => {\n                this.delete();\n            });\n\n\n            this.frameCount = 0;\n            this.blink = true;\n\n            game.onUpdate(() => {\n                this.frameCount = (this.frameCount + 1) % 30;\n\n                if (this.frameCount === 0) {\n                    this.blink = !this.blink;\n\n                    this.updateSelectedInput();\n                }\n            })\n        }\n\n        private moveVertical(up: boolean) {\n            if (up) {\n                if (this.cursorRow === 3) {\n                    this.cursor.image.fill(this.theme.colorCursor);\n                    this.cursorRow = 2;\n\n                    if (this.cursorColumn % 2) {\n                        this.cursorColumn = ALPHABET_ROW_LENGTH - 1;\n                    }\n                    else {\n                        this.cursorColumn = 0;\n                    }\n\n                    this.updateButtons();\n                }\n                else {\n                    this.cursorRow = Math.max(0, this.cursorRow - 1);\n                }\n            }\n            else {\n                this.cursorRow = Math.min(3, this.cursorRow + 1);\n\n                if (this.cursorRow === 3) {\n                    // Go to closest button\n                    this.cursorColumn = this.cursorColumn > 5 ? 1 : 0;\n                }\n            }\n\n            this.updateCursor();\n        }\n\n        private moveHorizontal(right: boolean) {\n            if (right) {\n                this.cursorColumn = (this.cursorColumn + 1) % ALPHABET_ROW_LENGTH;\n            }\n            else {\n                this.cursorColumn = (this.cursorColumn + (ALPHABET_ROW_LENGTH - 1)) % ALPHABET_ROW_LENGTH;\n            }\n\n            this.updateCursor();\n        }\n\n        private confirm() {\n            if (this.cursorRow === 3) {\n                if (this.cursorColumn % 2) {\n                    this.confirmPressed = true;\n                }\n                else {\n                    this.upper = !this.upper;\n                    this.updateKeyboard();\n                    this.updateButtons();\n                }\n            }\n            else {\n                if (this.inputIndex >= this.answerLength) return;\n\n                const index = this.cursorColumn + this.cursorRow * ALPHABET_ROW_LENGTH\n                const letter = getCharForIndex(index, this.upper);\n\n                if (!this.result) {\n                    this.result = letter;\n                }\n                else {\n                    this.result += letter;\n                }\n\n                const sprite = this.inputs[this.inputIndex];\n                this.changeInputIndex(1);\n                this.drawInput(sprite.image, letter, this.theme.colorInput);\n            }\n        }\n\n        private delete() {\n            if (this.inputIndex <= 0) return;\n\n            if (this.inputIndex < this.answerLength) {\n                this.drawInput(this.inputs[this.inputIndex].image, \"\", this.theme.colorInput);\n            }\n\n            this.result = this.result.substr(0, this.result.length - 1);\n\n            this.changeInputIndex(-1);\n        }\n\n        private changeInputIndex(delta: number) {\n            this.inputIndex += delta;\n            this.frameCount = 0\n            this.blink = false;\n            this.updateSelectedInput();\n        }\n    }\n\n    function layoutText(message: string, width: number, height: number, color: number) {\n        const lineHeight = font.charHeight + PROMPT_LINE_SPACING;\n\n        const lineLength = Math.floor(width / font.charWidth);\n        const numLines = Math.floor(height / lineHeight);\n\n        let lines: string[] = [];\n        let word: string;\n        let line: string;\n\n        let pushWord = () => {\n            if (line) {\n                if (line.length + word.length + 1 > lineLength) {\n                    lines.push(line);\n                    line = word;\n                }\n                else {\n                    line = line + \" \" + word;\n                }\n            }\n            else {\n                line = word;\n            }\n\n            word = null;\n        }\n\n        for (let l = 0; l < message.length; l++) {\n            const char = message.charAt(l);\n\n            if (char === \" \") {\n                if (word) {\n                    pushWord();\n                }\n                else {\n                    word = \" \";\n                }\n            }\n            else if (!word) {\n                word = char;\n            }\n            else {\n                word += char;\n            }\n        }\n\n        if (word) {\n            pushWord();\n        }\n\n        if (line) {\n            lines.push(line);\n        }\n\n        let maxLineWidth = 0;\n        for (let m = 0; m < lines.length; m++) {\n            maxLineWidth = Math.max(maxLineWidth, lines[m].length);\n        }\n\n        const actualWidth = maxLineWidth * font.charWidth;\n        const actualHeight = lines.length * lineHeight;\n\n        const res = image.create(actualWidth, actualHeight);\n\n        for (let n = 0; n < lines.length; n++) {\n            if ((n + 1) > numLines) break;\n            res.print(lines[n], 0, n * lineHeight, color, font);\n        }\n\n        return res;\n    }\n\n    function getCharForIndex(index: number, upper: boolean) {\n        if (index < 26) {\n            return String.fromCharCode(index + (upper ? 65 : 97));\n        }\n        else {\n            if (upper) {\n                return digitsUpper[index - 26];\n            }\n            else {\n                return \"\" + (index - 26);\n            }\n        }\n    }\n}\n\n"}]}],"snapshots":[{"timestamp":1756007732949,"editorVersion":"2.0.56","text":{"main.ts":" ","README.md":" ","assets.json":"","pxt.json":"{\n    \"name\": \"prompt\",\n    \"description\": \"\",\n    \"dependencies\": {\n        \"device\": \"*\"\n    },\n    \"files\": [\n        \"main.ts\",\n        \"README.md\",\n        \"assets.json\"\n    ],\n    \"preferredEditor\": \"tsprj\",\n    \"languageRestriction\": \"javascript-only\",\n    \"additionalFilePaths\": []\n}\n"}}],"shares":[],"lastSaveTime":1756008029550}